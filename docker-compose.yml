version: "3.9"

services:
  # --- Core stores ---
  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]

  mongo:
    image: mongo:7
    ports: ["27017:27017"]
    volumes:
      - mongo_data:/data/db

  postgres:
    image: ankane/pgvector:latest
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: vector
    ports: ["5432:5432"]
    volumes:
      - pg_data:/var/lib/postgresql/data

  # --- Admin GUIs ---
  redisinsight:
    image: redislabs/redisinsight:latest
    ports: ["5540:5540"]
    depends_on: [redis]
    environment:
      RI_ALLOW_ERRORS: "true"

  mongo-express:
    image: mongo-express:1.0.2
    environment:
      ME_CONFIG_MONGODB_SERVER: mongo
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin123
    ports: ["8081:8081"]
    depends_on: [mongo]

  # --- AI services ---
  ai:
    build: ./ai
    ports: ["8001:8001"]

  embeddings:
    build: ./embeddings
    environment:
      VECTOR_DIM: "384"
    ports: ["8002:8002"]

  # --- App images (built from repo root Dockerfile; outputs dist/src/*.js) ---
  worker:
    build: .
    environment:
      REDIS_URL: redis://redis:6379
      RESULTS_DB_KEY: crawl:results_db
      RESULTS_RAW_KEY: crawl:results_raw
      HEADLESS: "true"
      MAX_DEPTH: "3"
      AI_MODE: "true" # true = AI extract; false + INCLUDE_SELECTORS to use CSS mode
      INCLUDE_SELECTORS: "" # e.g. ".product-title,.product-body"
      METRICS_PORT: "9100"
      REVISIT_KEY: ai:revisit
      REVISIT_PENDING_KEY: ai:revisit:pending
      SEEN_KEY: crawl:seen
      # Optional cookie (uncomment & set if needed)
      # COOKIE_URL: "https://www.lauritz.com"
      # COOKIE_NAME: "CookieConsent"
      # COOKIE_VALUE: "<cookie value>"
      # COOKIE_DOMAIN: ".lauritz.com"
      # COOKIE_PATH: "/"
    depends_on: [redis]
    command: ["node", "dist/src/worker.js"]

  collector_mongo:
    build: .
    environment:
      REDIS_URL: redis://redis:6379
      RESULTS_DB_KEY: crawl:results_db
      MONGO_URL: mongodb://mongo:27017
      DB_NAME: crawler
      COL_PAGES: pages
      COL_PRODUCTS: products
      PRODUCT_URL_REGEX: "/[^/]+/(\\d+)(?:\\?.*)?$"
      METRICS_PORT: "9101"
    depends_on: [redis, mongo]
    command: ["node", "dist/src/collector-mongo.js"]

  collector_s3:
    build: .
    environment:
      REDIS_URL: redis://redis:6379
      RESULTS_RAW_KEY: crawl:results_raw
      S3_DIR: /data/lake # write locally under ./data/lake
      METRICS_PORT: "9104"
    volumes:
      - ./data:/data
    depends_on: [redis]
    command: ["node", "dist/src/collector-s3.js"]

  ai_enricher:
    build: .
    environment:
      REDIS_URL: redis://redis:6379
      MONGO_URL: mongodb://mongo:27017
      DB_NAME: crawler
      COL_PAGES: pages
      REVISIT_KEY: ai:revisit
      REVISIT_PENDING_KEY: ai:revisit:pending
      SEEN_KEY: crawl:seen
      INCLUDE_SELECTORS: "" # if non-empty, revisits are optional
      ENABLE_REVISIT: "true"
      AI_URL: http://ai:8001/detect
      AI_BATCH: "12"
      AI_TIMEOUT_MS: "15000"
      AI_TEXT_LIMIT: "4000"
      MIN_CONF: "0.65"
      METRICS_PORT: "9102"
    depends_on: [mongo, ai, redis]
    command: ["node", "dist/src/ai-enricher.js"]

  collector_embed:
    build: .
    environment:
      MONGO_URL: mongodb://mongo:27017
      DB_NAME: crawler
      COL_PAGES: pages
      PG_HOST: postgres
      PG_PORT: "5432"
      PG_DB: vector
      PG_USER: postgres
      PG_PASS: postgres
      EMBEDDER_URL: http://embeddings:8002/embed
      EMBED_BATCH: "24"
      VECTOR_DIM: "384"
      INLINE_VECTOR_SQL: "true"
      METRICS_PORT: "9103"
    depends_on: [mongo, postgres, embeddings]
    command: ["node", "dist/src/collector-embed.js"]

  # --- Monitoring stack ---
  redis_exporter:
    image: oliver006/redis_exporter:v1.62.0
    command: ["--redis.addr=redis://redis:6379"]
    ports: ["9121:9121"]
    depends_on: [redis]

  mongodb_exporter:
    image: percona/mongodb_exporter:0.40.0
    environment:
      MONGODB_URI: mongodb://mongo:27017
    ports: ["9216:9216"]
    depends_on: [mongo]

  postgres_exporter:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    environment:
      DATA_SOURCE_NAME: postgresql://postgres:postgres@postgres:5432/vector?sslmode=disable
    ports: ["9187:9187"]
    depends_on: [postgres]

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    ports: ["8080:8080"]
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro

  prometheus:
    image: prom/prometheus:v2.54.1
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports: ["9090:9090"]
    depends_on:
      [worker, redis_exporter, mongodb_exporter, postgres_exporter, cadvisor]

  grafana:
    image: grafana/grafana:11.2.2
    ports: ["3000:3000"]
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin123
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on: [prometheus]

volumes:
  mongo_data:
  pg_data:
